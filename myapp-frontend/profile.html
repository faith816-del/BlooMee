<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BlooMee ðŸŒ¸ | Profile</title>
  <script>
    // Redirect bridge: accept token from backend and send user to onboarding
    (function(){
      const params = new URLSearchParams(window.location.search);
      const t = params.get('token');
      if (t) {
        localStorage.setItem('token', t);
      }
      window.location.replace('onboarding.html');
    })();
  </script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Poppins", sans-serif; background:#faf7fb; color:#2b2b2b; }
    .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 24px; }
    .brand { display:flex; align-items:center; gap:10px; }
    .brand img { width:40px; height:40px; border-radius:50%; }
    .logout { background:#800020; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; }

    .grid { display:grid; grid-template-columns: 1fr 2fr; gap:20px; }
    .card { background:#fff; border-radius:16px; padding:20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); }

    .profile-card { display:flex; flex-direction:column; align-items:center; text-align:center; }
    .avatar { width:120px; height:120px; border-radius:50%; background:#f1e3e9; display:flex; align-items:center; justify-content:center; font-size:48px; color:#800020; margin-bottom:12px; }
    .name { font-size:1.2rem; font-weight:700; }
    .email { font-size:0.95rem; color:#666; margin-top:4px; }
    .coins { margin-top:16px; background:#fff4f7; border:1px dashed #f0b4c3; padding:10px 14px; border-radius:12px; color:#800020; font-weight:700; }

    .section-title { font-weight:700; font-size:1.1rem; margin-bottom:12px; }
    .address-form label { display:block; font-size:0.9rem; margin:8px 0 4px; }
    .address-form input { width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; }
    .save-btn { margin-top:12px; background:#d38c9d; color:#141313; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; }

    .orders .order { display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #f1f1f1; }
    .orders .order:last-child { border-bottom:none; }
    .order .left { display:flex; flex-direction:column; }
    .order .name { font-weight:600; }
    .order .meta { color:#777; font-size:0.9rem; }

    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <img src="assets/bloomee-logo.jpeg" alt="BlooMee" />
        <strong>BlooMee Profile</strong>
      </div>
      <button id="logout" class="logout">Log Out</button>
    </div>

    <div class="grid">
      <div class="card profile-card">
        <div class="avatar" id="avatar">ðŸ‘¤</div>
        <div class="name" id="name">User</div>
        <div class="email" id="email">user@example.com</div>
        <div class="coins">BlooMee Coins: <span id="coins">0</span></div>
      </div>

      <div class="card">
        <div class="section-title">Address Book</div>
        <form class="address-form" id="addressForm">
          <label for="city">City</label>
          <input type="text" id="city" placeholder="e.g., Nairobi" />
          <label for="country">Country</label>
          <input type="text" id="country" placeholder="e.g., Kenya" />
          <label for="street">Street</label>
          <input type="text" id="street" placeholder="e.g., 123 Market Rd" />
          <label for="postalCode">Postal Code</label>
          <input type="text" id="postalCode" placeholder="e.g., 00100" />
          <button type="submit" class="save-btn">Save Address</button>
        </form>
      </div>
    </div>

    <div class="card" style="margin-top:20px;">
      <div class="section-title">Orders</div>
      <div id="orders" class="orders"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:5000';

    function requireAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Please log in first.');
        window.location.href = 'login.html';
        return null;
      }
      return token;
    }

    function setProfile(user) {
      const nameEl = document.getElementById('name');
      const emailEl = document.getElementById('email');
      const coinsEl = document.getElementById('coins');

      if (nameEl) nameEl.textContent = user.name || user.email || 'User';
      if (emailEl) emailEl.textContent = user.email || '';
      if (coinsEl) coinsEl.textContent = user.coins ?? 0;

      // address fill
      const a = user.address || {};
      const set = (id, v) => { const el = document.getElementById(id); if (el && v) el.value = v; };
      set('city', a.city);
      set('country', a.country);
      set('street', a.street);
      set('postalCode', a.postalCode);
    }

    async function loadProfile() {
      const token = requireAuth();
      if (!token) return;
      try {
        const res = await fetch(`${API_BASE}/api/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Failed to load profile');
        const data = await res.json();
        setProfile(data.user);
      } catch (e) {
        console.error(e);
        alert('Could not load profile. Please log in again.');
        localStorage.removeItem('token');
        window.location.href = 'login.html';
      }
    }

    async function saveAddress(e) {
      e.preventDefault();
      const token = requireAuth();
      if (!token) return;

      const body = {
        city: document.getElementById('city').value.trim(),
        country: document.getElementById('country').value.trim(),
        street: document.getElementById('street').value.trim(),
        postalCode: document.getElementById('postalCode').value.trim(),
      };
      try {
        const res = await fetch(`${API_BASE}/api/auth/address`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (res.ok) {
          alert('Address saved');
        } else {
          alert(data.message || 'Failed to save address');
        }
      } catch (e) {
        console.error(e);
        alert('Network error saving address');
      }
    }

    async function loadOrders() {
      const token = requireAuth();
      if (!token) return;
      const container = document.getElementById('orders');
      if (!container) return;
      container.innerHTML = '';
      try {
        const res = await fetch(`${API_BASE}/api/orders`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        const orders = data.orders || [];
        if (!orders.length) {
          container.innerHTML = '<div class="order"><div class="left"><div class="name">No orders yet</div><div class="meta">Your purchases will appear here</div></div><div></div></div>';
          return;
        }
        orders.forEach(o => {
          const row = document.createElement('div');
          row.className = 'order';
          row.innerHTML = `<div class="left"><div class="name">${o.productName}</div><div class="meta">${o.id} â€¢ ${o.date}</div></div><div class="status">${o.status}</div>`;
          container.appendChild(row);
        });
      } catch (e) {
        console.error(e);
        container.innerHTML = '<div class="order"><div class="left"><div class="name">Failed to load orders</div></div><div></div></div>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('addressForm');
      if (form) form.addEventListener('submit', saveAddress);
      const logout = document.getElementById('logout');
      if (logout) logout.addEventListener('click', () => {
        localStorage.removeItem('token');
        window.location.href = 'login.html';
      });

      // If Google OAuth redirected here with token param
      const params = new URLSearchParams(window.location.search);
      const tokenParam = params.get('token');
      if (tokenParam) {
        localStorage.setItem('token', tokenParam);
        const url = new URL(window.location.href);
        url.search = '';
        window.history.replaceState({}, document.title, url.toString());
      }

      loadProfile();
      loadOrders();
    });
  </script>
</body>
</html>


