<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Tools - Cart & Profile</title>
<style>
  body { font-family: Poppins, sans-serif; margin:0; background:#fff6fa; }
  header.main-header { display:flex; justify-content:space-between; align-items:center; background:#d38c9d; padding:10px; color:white; }
  header .logo img { height:40px; cursor:pointer; }
  .nav { display:flex; gap:10px; }
  .nav button { background:white; color:#d38c9d; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:bold; }
  .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  .modal-content { background:white; border-radius:12px; padding:20px; width:90%; max-width:400px; position:relative; }
  .close { position:absolute; top:10px; right:10px; cursor:pointer; font-weight:bold; color:#d38c9d; font-size:18px; }
  .cart-item { display:flex; justify-content:space-between; align-items:center; margin:8px 0; border-bottom:1px solid #eee; padding-bottom:8px; }
  .cart-item button { background:#d38c9d; color:white; border:none; border-radius:50%; width:25px; height:25px; cursor:pointer; }
  .checkout-btn { background:#d38c9d; color:white; border:none; padding:10px; width:100%; border-radius:8px; cursor:pointer; margin-top:8px; }
  input { width:100%; margin-bottom:8px; padding:8px; border-radius:6px; border:1px solid #ccc; }
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header class="main-header">
  <div class="logo" onclick="window.location.href='home.html'">
    <img src="assets/bloomee-logo.jpeg" alt="BlooMee Logo">
  </div>
  <div class="nav">
    <button id="cartBtn">üõí Cart (<span id="cart-count">0</span>)</button>
    <button id="profileBtn">üë§ Profile</button>
  </div>
</header>

<!-- ===== CART MODAL ===== -->
<div class="modal" id="cartModal">
  <div class="modal-content">
    <span class="close" id="closeCart">‚úñ</span>
    <h3>Your Cart</h3>
    <div id="cartItems"></div>
    <p><strong>Total:</strong> KES <span id="cartTotal">0</span></p>
    <button class="checkout-btn" id="checkoutBtn">Checkout</button>
  </div>
</div>

<!-- ===== CHECKOUT MODAL ===== -->
<div class="modal" id="checkoutModal">
  <div class="modal-content">
    <span class="close" id="closeCheckout">‚úñ</span>
    <h3>Shipping Details</h3>
    <div id="checkoutForm">
      <input type="text" id="shipName" placeholder="Full Name" required>
      <input type="email" id="shipEmail" placeholder="Email Address" required>
      <input type="tel" id="shipPhone" placeholder="Phone Number" required>
      <input type="text" id="shipCounty" placeholder="County" required>
      <input type="text" id="shipSubcounty" placeholder="Sub-county" required>
      <input type="text" id="shipStreet" placeholder="Street Address" required>
      <button id="continueCheckout" class="checkout-btn">Continue</button>
    </div>
    <div id="checkoutSummary" style="display:none;">
      <h4>Confirm Your Order</h4>
      <p id="summaryDetails"></p>
      <p><strong>Payment Method:</strong> Payment on Delivery</p>
      <button id="confirmOrder" class="checkout-btn">Make Order</button>
    </div>
    <div id="orderSuccess" style="display:none;text-align:center;padding:20px;font-weight:bold;color:green;">
      ‚úÖ Order placed successfully!
    </div>
  </div>
</div>

<!-- ===== PROFILE MODAL (integrated modern profile) ===== -->
<div class="modal" id="profileModal">
  <div class="modal-content" style="max-width:900px; width:95%;">
    <span class="close" id="closeProfile">‚úñ</span>
    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:16px;">
      <div class="card" style="background:#fff; border-radius:12px; padding:16px; box-shadow:0 8px 20px rgba(0,0,0,0.05); text-align:center;">
        <div style="width:100px; height:100px; border-radius:50%; background:#f1e3e9; display:flex; align-items:center; justify-content:center; font-size:42px; color:#800020; margin:0 auto 10px;">üë§</div>
        <div style="font-weight:700;" id="profName">User</div>
        <div style="color:#777; font-size:0.95rem;" id="profEmail">user@example.com</div>
        <div style="margin-top:12px; background:#fff4f7; border:1px dashed #f0b4c3; padding:8px 10px; border-radius:10px; color:#800020; font-weight:700;">BlooMee Coins: <span id="profCoins">0</span></div>
        <button id="logoutBtn" class="checkout-btn" style="background:#e74c3c; margin-top:12px;">Logout</button>
      </div>
      <div class="card" style="background:#fff; border-radius:12px; padding:16px; box-shadow:0 8px 20px rgba(0,0,0,0.05);">
        <div style="font-weight:700; margin-bottom:10px;">Address Book</div>
        <form id="addressForm">
          <input type="text" id="addrCity" placeholder="City" />
          <input type="text" id="addrCountry" placeholder="Country" />
          <input type="text" id="addrStreet" placeholder="Street" />
          <input type="text" id="addrPostal" placeholder="Postal Code" />
          <button type="submit" class="checkout-btn" style="margin-top:8px;">Save Address</button>
        </form>
      </div>
    </div>
    <div class="card" style="background:#fff; border-radius:12px; padding:16px; box-shadow:0 8px 20px rgba(0,0,0,0.05); margin-top:12px;">
      <div style="font-weight:700; margin-bottom:10px;">Orders</div>
      <div id="ordersList"></div>
    </div>
  </div>
  </div>

<!-- ===== FOOTER ===== -->
<div id="footer-container"></div>
<script>
  fetch("footer.html")
    .then(res => res.text())
    .then(data => document.getElementById("footer-container").innerHTML = data);
</script>

<script>
let cart = JSON.parse(localStorage.getItem("cart")) || [];
function updateCartCount(){
  const count = cart.reduce((sum,item)=>sum+item.quantity,0);
  document.getElementById("cart-count").textContent = count;
}
updateCartCount();

// Modals
const cartBtn = document.getElementById("cartBtn");
const profileBtn = document.getElementById("profileBtn");
const cartModal = document.getElementById("cartModal");
const profileModal = document.getElementById("profileModal");
const checkoutModal = document.getElementById("checkoutModal");
const closeCart = document.getElementById("closeCart");
const closeProfile = document.getElementById("closeProfile");
const closeCheckout = document.getElementById("closeCheckout");
const cartItemsDiv = document.getElementById("cartItems");
const cartTotal = document.getElementById("cartTotal");

// Open/close
cartBtn.onclick = ()=>{ renderCart(); cartModal.style.display="flex"; }
closeCart.onclick = ()=>cartModal.style.display="none";
profileBtn.onclick = ()=>openProfile();
closeProfile.onclick = ()=>profileModal.style.display="none";
closeCheckout.onclick = ()=>checkoutModal.style.display="none";

// Cart functions
function renderCart(){
  cartItemsDiv.innerHTML="";
  let total=0;
  if(cart.length===0){ cartItemsDiv.innerHTML="<p>Your cart is empty.</p>"; }
  else{
    cart.forEach((item,i)=>{
      total+=item.price*item.quantity;
      cartItemsDiv.innerHTML+=`
        <div class="cart-item">
          <span>${item.name} (KES ${item.price}) x ${item.quantity}</span>
          <div>
            <button onclick="updateQuantity(${i},1)">+</button>
            <button onclick="updateQuantity(${i},-1)">-</button>
            <button onclick="removeItem(${i})">üóëÔ∏è</button>
          </div>
        </div>`;
    });
  }
  cartTotal.textContent = total.toFixed(2);
  updateCartCount();
}
function updateQuantity(i,change){ cart[i].quantity+=change; if(cart[i].quantity<=0) cart.splice(i,1); localStorage.setItem("cart",JSON.stringify(cart)); renderCart(); }
function removeItem(i){ cart.splice(i,1); localStorage.setItem("cart",JSON.stringify(cart)); renderCart(); }

// Checkout
document.getElementById("checkoutBtn").onclick = ()=>{
  cartModal.style.display="none"; checkoutModal.style.display="flex";
}
document.getElementById("continueCheckout").onclick = ()=>{
  const name=document.getElementById("shipName").value.trim(),
        email=document.getElementById("shipEmail").value.trim(),
        phone=document.getElementById("shipPhone").value.trim(),
        county=document.getElementById("shipCounty").value.trim(),
        subcounty=document.getElementById("shipSubcounty").value.trim(),
        street=document.getElementById("shipStreet").value.trim();
  if(!name||!email||!phone||!county||!subcounty||!street){ alert("Please fill all details!"); return; }
  document.getElementById("summaryDetails").innerHTML = `<strong>Name:</strong>${name}<br><strong>Email:</strong>${email}<br><strong>Phone:</strong>${phone}<br><strong>County:</strong>${county}<br><strong>Sub-county:</strong>${subcounty}<br><strong>Street:</strong>${street}<br>`;
  document.getElementById("checkoutForm").style.display="none";
  document.getElementById("checkoutSummary").style.display="block";
}
document.getElementById("confirmOrder").onclick = ()=>{
  document.getElementById("checkoutSummary").style.display="none";
  document.getElementById("orderSuccess").style.display="block";
  cart=[]; localStorage.removeItem("cart"); updateCartCount();
  setTimeout(()=>{ document.getElementById("orderSuccess").style.display="none"; checkoutModal.style.display="none"; },3000);
}

// Profile helpers
function requireAuth(){ const t=localStorage.getItem('token'); if(!t){ window.location.href='login.html'; return null;} return t; }
async function openProfile(){
  const token=requireAuth();
  if(!token) return;
  await loadProfileData(token);
  profileModal.style.display="flex";
}
async function loadProfileData(token){
  try{
    const res = await fetch('http://localhost:5000/api/auth/me', { headers:{ Authorization:`Bearer ${token}` }});
    if(!res.ok) throw new Error('Fail');
    const data = await res.json();
    const u = data.user || {};
    document.getElementById('profName').textContent = u.name || u.email || 'User';
    document.getElementById('profEmail').textContent = u.email || '';
    document.getElementById('profCoins').textContent = u.coins ?? 0;
    if(u.address){
      document.getElementById('addrCity').value = u.address.city || '';
      document.getElementById('addrCountry').value = u.address.country || '';
      document.getElementById('addrStreet').value = u.address.street || '';
      document.getElementById('addrPostal').value = u.address.postalCode || '';
    }
  }catch(e){ console.error(e); }
  await loadOrdersList(token);
}
async function loadOrdersList(token){
  const wrap = document.getElementById('ordersList');
  if(!wrap) return;
  wrap.innerHTML='';
  try{
    const r = await fetch('http://localhost:5000/api/orders', { headers:{ Authorization:`Bearer ${token}` }});
    const d = await r.json();
    const orders = d.orders || [];
    if(!orders.length){ wrap.innerHTML='<div>No orders yet</div>'; return; }
    orders.forEach(o=>{
      const row=document.createElement('div');
      row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='8px 0'; row.style.borderBottom='1px solid #f1f1f1';
      row.innerHTML = `<div><div style="font-weight:600;">${o.productName}</div><div style="color:#777; font-size:0.9rem;">${o.id} ‚Ä¢ ${o.date}</div></div><div>${o.status}</div>`;
      wrap.appendChild(row);
    });
  }catch(e){ wrap.innerHTML='<div>Failed to load orders</div>'; }
}

document.getElementById('addressForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const token=requireAuth();
  if(!token) return;
  const body={ city:addrCity.value.trim(), country:addrCountry.value.trim(), street:addrStreet.value.trim(), postalCode:addrPostal.value.trim() };
  try{
    const r = await fetch('http://localhost:5000/api/auth/address', { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body:JSON.stringify(body)});
    const d = await r.json();
    if(r.ok) alert('Address saved'); else alert(d.message||'Failed to save address');
  }catch(err){ alert('Network error'); }
});

document.getElementById('logoutBtn').addEventListener('click', ()=>{
  localStorage.removeItem('token');
  profileModal.style.display='none';
  window.location.href='login.html';
});

// Open profile immediately if navigated with #profile
document.addEventListener('DOMContentLoaded', ()=>{
  if (window.location.hash === '#profile') {
    openProfile();
  }
});
</script>
</body>
</html>
